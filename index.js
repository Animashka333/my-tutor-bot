const { Telegraf } = require('telegraf');

const BOT_TOKEN = '7099638631:AAHWoLCmXPsXa3yi-RRhw9htZj-IJEI6FjA';
const bot = new Telegraf(BOT_TOKEN);

// ID Ð¿Ñ€Ð¸Ð²Ð°Ñ‚Ð½Ð¾Ð¹ Ð³Ñ€ÑƒÐ¿Ð¿Ñ‹
const GROUP_ID = '-1002008510442'; // âœ… Ð’Ð°Ñˆ Ñ€ÐµÐ°Ð»ÑŒÐ½Ñ‹Ð¹ ID Ð³Ñ€ÑƒÐ¿Ð¿Ñ‹

// Ð¡ÑÑ‹Ð»ÐºÐ¸ (Ð·Ð°Ð¼ÐµÐ½Ð¸Ñ‚Ðµ Ð½Ð° Ñ€ÐµÐ°Ð»ÑŒÐ½Ñ‹Ðµ)
const GROUP_LINK = 'https://t.me/+GFITSpvrpsQxZjcy'; // Ð¡ÑÑ‹Ð»ÐºÐ° Ð½Ð° Ð³Ñ€ÑƒÐ¿Ð¿Ñƒ
const TEACHER_USERNAME = '@Irina_Burtseva_333'; // Username ÑƒÑ‡Ð¸Ñ‚ÐµÐ»Ñ
const PRESENTATIONS_LINK = 'https://drive.google.com/your-link-here'; // Ð¡ÑÑ‹Ð»ÐºÐ° Ð½Ð° Google Drive Ñ Ð¿Ñ€ÐµÐ·ÐµÐ½Ñ‚Ð°Ñ†Ð¸ÑÐ¼Ð¸

// Ð¡ÑÑ‹Ð»ÐºÐ° Ð½Ð° ÐºÐ°Ñ€Ñ‚Ð¸Ð½ÐºÑƒ
const PHOTO_URL = 'https://i.postimg.cc/LnF6ykdt/image.jpg'; // âœ… Ð’Ð°ÑˆÐ° Ñ€ÐµÐ°Ð»ÑŒÐ½Ð°Ñ ÐºÐ°Ñ€Ñ‚Ð¸Ð½ÐºÐ°

// ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸Ðº ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹ /start
bot.start((ctx) => {
  return ctx.reply(
    'Ð”Ð¾Ð±Ñ€Ð¾ Ð¿Ð¾Ð¶Ð°Ð»Ð¾Ð²Ð°Ñ‚ÑŒ Ð½Ð° ÐºÑƒÑ€Ñ! Ð”Ð°Ð²Ð°Ð¹Ñ‚Ðµ Ð¿Ñ€Ð¾Ð²ÐµÑ€Ð¸Ð¼, Ð³Ð¾Ñ‚Ð¾Ð²Ñ‹ Ð»Ð¸ Ð²Ñ‹ Ðº Ð¿Ñ€Ð¾Ñ…Ð¾Ð¶Ð´ÐµÐ½Ð¸ÑŽ?',
    {
      reply_markup: {
        inline_keyboard: [
          [{ text: 'ÐŸÑ€Ð¾Ð²ÐµÑ€Ð¸Ñ‚ÑŒ', callback_data: 'check_ready' }]
        ]
      }
    }
  );
});

// ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸Ðº Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸ Ð³Ð¾Ñ‚Ð¾Ð²Ð½Ð¾ÑÑ‚Ð¸
bot.action('check_ready', (ctx) => {
  ctx.answerCbQuery().catch(() => {});

  return ctx.editMessageText(
    'ðŸš€ Ð”Ð»Ñ ÑÑ‚Ð°Ñ€Ñ‚Ð° ÐºÑƒÑ€ÑÐ° Ð¿Ñ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ Ñ‡Ñ‚Ð¾:\n' +
    '1. ÐŸÑ€Ð¾Ð³Ñ€Ð°Ð¼Ð¼Ð° Ñ‚ÐµÐ»ÐµÐ³Ñ€Ð°Ð¼Ð¼ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð° Ð½Ð° Ð²Ð°ÑˆÐµÐ¼ ÐºÐ¾Ð¼Ð¿ÑŒÑŽÑ‚ÐµÑ€Ðµ.\n\n' +
    'ðŸ‘‰ Ð•ÑÐ»Ð¸ Ð²Ñ‹ ÐµÑ‰Ðµ Ð½Ðµ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ð»Ð¸ Ð¿Ñ€Ð¾Ð³Ñ€Ð°Ð¼Ð¼Ñƒ Ñ‚ÐµÐ»ÐµÐ³Ñ€Ð°Ð¼Ð¼ Ð½Ð° ÐºÐ¾Ð¼Ð¿ÑŒÑŽÑ‚ÐµÑ€, Ñ‚Ð¾ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚Ðµ ÐµÑ‘ ÑÐ°Ð¼Ð¾ÑÑ‚Ð¾ÑÑ‚ÐµÐ»ÑŒÐ½Ð¾ Ð¸Ð»Ð¸ Ð¿Ð¾ÑÐ¼Ð¾Ñ‚Ñ€Ð¸Ñ‚Ðµ Ð²Ð¸Ð´ÐµÐ¾-Ð¸Ð½ÑÑ‚Ñ€ÑƒÐºÑ†Ð¸ÑŽ Ð¿Ð¾ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐµ Ñ€ÑƒÑÑÐºÐ¾Ð¹ Ð²ÐµÑ€ÑÐ¸Ð¸ Ñ‚ÐµÐ»ÐµÐ³Ñ€Ð°Ð¼Ð¼ Ð½Ð° ÐºÐ¾Ð¼Ð¿ÑŒÑŽÑ‚ÐµÑ€.\n\n' +
    'âœ… ÐŸÐ¾ÑÐ»Ðµ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ñ ÑƒÑÐ»Ð¾Ð²Ð¸Ð¹ Ð½Ð°Ð¶Ð¼Ð¸Ñ‚Ðµ ÐºÐ½Ð¾Ð¿ÐºÑƒ "ÐŸÑ€Ð¾Ð´Ð¾Ð»Ð¶Ð¸Ñ‚ÑŒ"',
    {
      parse_mode: 'HTML',
      disable_web_page_preview: true,
      reply_markup: {
        inline_keyboard: [
          [{ 
            text: 'Ð˜Ð½ÑÑ‚Ñ€ÑƒÐºÑ†Ð¸Ñ', 
            url: 'https://rutube.ru/video/1ee124b1c2b20ca0c471d8e249f4126d/'
          }],
          [{ text: 'ÐŸÑ€Ð¾Ð´Ð¾Ð»Ð¶Ð¸Ñ‚ÑŒ', callback_data: 'continue_course' }]
        ]
      }
    }
  );
});

// ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸Ðº Ð¿Ñ€Ð¾Ð´Ð¾Ð»Ð¶ÐµÐ½Ð¸Ñ ÐºÑƒÑ€ÑÐ° - Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð¿Ð¾Ð´Ð¿Ð¸ÑÐºÐ¸
bot.action('continue_course', async (ctx) => {
  try {
    ctx.answerCbQuery().catch(() => {});
    
    const userId = ctx.from.id;
    
    // ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð¿Ð¾Ð´Ð¿Ð¸ÑÐºÑƒ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ Ð½Ð° Ð³Ñ€ÑƒÐ¿Ð¿Ñƒ
    let isSubscribed = false;
    try {
      const chatMember = await ctx.telegram.getChatMember(GROUP_ID, userId);
      if (['member', 'administrator', 'creator'].includes(chatMember.status)) {
        isSubscribed = true;
      }
    } catch (error) {
      console.error('ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸ Ð¿Ð¾Ð´Ð¿Ð¸ÑÐºÐ¸:', error);
      isSubscribed = false;
    }

    if (isSubscribed) {
      // âœ… ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ Ð¿Ð¾Ð´Ð¿Ð¸ÑÐ°Ð½ Ð½Ð° Ð³Ñ€ÑƒÐ¿Ð¿Ñƒ
      return ctx.editMessageText(
        'âœ… ÐžÑ‚Ð»Ð¸Ñ‡Ð½Ð¾! Ð£ÑÐ¿ÐµÑˆÐ½Ð¾Ð¹ ÑƒÑ‡ÐµÐ±Ñ‹',
        {
          parse_mode: 'HTML',
          reply_markup: {
            inline_keyboard: [
              [{ text: 'Ð”Ð°Ð»ÐµÐµ', callback_data: 'next_step' }]
            ]
          }
        }
      );
    } else {
      // âŒ ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ ÐÐ• Ð¿Ð¾Ð´Ð¿Ð¸ÑÐ°Ð½ Ð½Ð° Ð³Ñ€ÑƒÐ¿Ð¿Ñƒ
      return ctx.editMessageText(
        'âŒ Ðš ÑÐ¾Ð¶Ð°Ð»ÐµÐ½Ð¸ÑŽ Ð¼Ñ‹ Ð½Ðµ Ð½Ð°ÑˆÐ»Ð¸ Ð²Ð°ÑˆÑƒ Ð¿Ð¾Ð´Ð¿Ð¸ÑÐºÑƒ Ð½Ð° Ð³Ñ€ÑƒÐ¿Ð¿Ñƒ ÐºÑƒÑ€ÑÐ°.\n\n' +
        'ÐŸÐ¾Ð¶Ð°Ð»ÑƒÐ¹ÑÑ‚Ð° Ð¿Ñ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ Ð²Ð°ÑˆÑƒ Ð¿Ð¾Ñ‡Ñ‚Ñƒ (Ð²Ð¼ÐµÑÑ‚Ðµ Ñ Ñ‡ÐµÐºÐ¾Ð¼ Ð¾Ð¿Ð»Ð°Ñ‚Ñ‹ Ð²Ð°Ð¼ Ð¿Ñ€Ð¸ÑˆÐ»Ð° ÑÑÑ‹Ð»ÐºÐ° Ð½Ð° Ð³Ñ€ÑƒÐ¿Ð¿Ñƒ). ÐŸÐ¾Ð´Ð¿Ð¸ÑˆÐ¸Ñ‚ÐµÑÑŒ Ð½Ð° Ð³Ñ€ÑƒÐ¿Ð¿Ñƒ Ð¸ Ð¿Ð¾ÑÐ»Ðµ Ð¿Ð¾Ð´Ð¿Ð¸ÑÐºÐ¸ Ð±Ð¾Ñ‚ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ Ð²Ð°Ð¼ Ð¼Ð°Ñ‚ÐµÑ€Ð¸Ð°Ð»Ñ‹ ÐºÑƒÑ€ÑÐ°.\n\n' +
        'ÐÐ°Ð¿Ð¸ÑˆÐ¸Ñ‚Ðµ Ð½Ð°Ð¼ Ð¿Ñ€Ð¸ Ð²Ð¾Ð·Ð½Ð¸ÐºÐ½Ð¾Ð²ÐµÐ½Ð¸Ð¸ Ð´Ñ€ÑƒÐ³Ð¸Ñ… Ð²Ð¾Ð¿Ñ€Ð¾ÑÐ¾Ð² @Irina_Burtseva_333',
        {
          parse_mode: 'HTML',
          disable_web_page_preview: true
        }
      );
    }
  } catch (error) {
    console.error('ÐžÑˆÐ¸Ð±ÐºÐ° Ð² continue_course:', error);
    return ctx.editMessageText('ÐŸÑ€Ð¾Ð¸Ð·Ð¾ÑˆÐ»Ð° Ð¾ÑˆÐ¸Ð±ÐºÐ°. ÐŸÐ¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ Ð¿Ð¾Ð·Ð¶Ðµ.');
  }
});

// ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸Ðº ÐºÐ½Ð¾Ð¿ÐºÐ¸ "Ð”Ð°Ð»ÐµÐµ" - Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð»ÑÐµÐ¼ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ Ñ ÐºÐ°Ñ€Ñ‚Ð¸Ð½ÐºÐ¾Ð¹ Ð¸ ÐºÐ½Ð¾Ð¿ÐºÐ°Ð¼Ð¸
bot.action('next_step', async (ctx) => {
  try {
    ctx.answerCbQuery().catch(() => {});
    
    // Ð¡Ð½Ð°Ñ‡Ð°Ð»Ð° Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð»ÑÐµÐ¼ ÐºÐ°Ñ€Ñ‚Ð¸Ð½ÐºÑƒ Ñ Ð¿Ñ€Ð¸Ð²ÐµÑ‚ÑÑ‚Ð²Ð¸ÐµÐ¼ Ð¸ Ð¿ÐµÑ€Ð²Ñ‹Ð¼Ð¸ ÐºÐ½Ð¾Ð¿ÐºÐ°Ð¼Ð¸
    await ctx.replyWithPhoto(
      { url: PHOTO_URL }, // âœ… Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ Ð²Ð°ÑˆÑƒ Ñ€ÐµÐ°Ð»ÑŒÐ½ÑƒÑŽ ÐºÐ°Ñ€Ñ‚Ð¸Ð½ÐºÑƒ
      {
        caption: `ÐŸÑ€Ð¸Ð²ÐµÑ‚! ÐœÐµÐ½Ñ Ð·Ð¾Ð²ÑƒÑ‚ Ð˜Ñ€Ð¸Ð½Ð° Ð‘ÑƒÑ€Ñ†ÐµÐ²Ð°, Ñ Ñ‚Ð²Ð¾Ð¹ ÑƒÑ‡Ð¸Ñ‚ÐµÐ»ÑŒ! ÐœÑ‹ Ð±ÑƒÐ´ÐµÐ¼ Ð¸Ð·ÑƒÑ‡Ð°Ñ‚ÑŒ ÐºÐ°Ðº ÑƒÑÑ‚Ñ€Ð¾ÐµÐ½ ÐºÐ¾Ð¼Ð¿ÑŒÑŽÑ‚ÐµÑ€ Ð¸ Ñ‡Ñ‚Ð¾ Ð² Ð½ÐµÐ¼ Ð¼Ð¾Ð¶Ð½Ð¾ Ð´ÐµÐ»Ð°Ñ‚ÑŒ.`,
        parse_mode: 'HTML',
        reply_markup: {
          inline_keyboard: [
            // ÐšÐ½Ð¾Ð¿ÐºÐ° Ð³Ñ€ÑƒÐ¿Ð¿Ñ‹ - Ð¾Ñ‚Ð´ÐµÐ»ÑŒÐ½Ñ‹Ð¹ Ñ€ÑÐ´
            [{ text: 'ÐÐ°Ð¿Ð¸ÑÐ°Ñ‚ÑŒ Ð² Ð³Ñ€ÑƒÐ¿Ð¿Ñƒ Ð´Ð»Ñ Ð²Ð¾Ð¿Ñ€Ð¾ÑÐ¾Ð²', url: GROUP_LINK }],
            // ÐšÐ½Ð¾Ð¿ÐºÐ° ÑƒÑ‡Ð¸Ñ‚ÐµÐ»Ñ - Ð¾Ñ‚Ð´ÐµÐ»ÑŒÐ½Ñ‹Ð¹ Ñ€ÑÐ´
            [{ text: 'ÐÐ°Ð¿Ð¸ÑÐ°Ñ‚ÑŒ ÑƒÑ‡Ð¸Ñ‚ÐµÐ»ÑŽ Ð»Ð¸Ñ‡Ð½Ð¾', url: `https://t.me/${TEACHER_USERNAME.replace('@', '')}` }]
          ]
        }
      }
    );
    
    // Ð—Ð°Ñ‚ÐµÐ¼ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð»ÑÐµÐ¼ Ñ‚ÐµÐºÑÑ‚ Ð¿Ñ€Ð¾ Ð¿Ñ€ÐµÐ·ÐµÐ½Ñ‚Ð°Ñ†Ð¸Ð¸ Ð¸ ÐºÐ½Ð¾Ð¿ÐºÑƒ Ð¿Ñ€ÐµÐ·ÐµÐ½Ñ‚Ð°Ñ†Ð¸Ð¹
    await ctx.reply(
      `Ð’Ñ‹ Ð¼Ð¾Ð¶ÐµÑ‚Ðµ ÑÐºÐ°Ñ‡Ð°Ñ‚ÑŒ Ð¿Ñ€ÐµÐ·ÐµÐ½Ñ‚Ð°Ñ†Ð¸Ð¸ Ðº ÐºÐ°Ð¶Ð´Ð¾Ð¼Ñƒ ÑƒÑ€Ð¾ÐºÑƒ Ð¸Ð»Ð¸ ÑÐ¼Ð¾Ñ‚Ñ€ÐµÑ‚ÑŒ Ð¸Ñ… Ð² Ñ€ÐµÐ¶Ð¸Ð¼Ðµ Ð¾Ð½Ð»Ð°Ð¹Ð½ Ñ‚ÑƒÑ‚ (Ñ‚Ñ€ÐµÐ±ÑƒÐµÑ‚ÑÑ Ð³ÑƒÐ³Ð» Ð°ÐºÐºÐ°ÑƒÐ½Ñ‚):`,
      {
        parse_mode: 'HTML',
        disable_web_page_preview: true,
        reply_markup: {
          inline_keyboard: [
            [{ text: 'Ð’ÑÐµ Ð¿Ñ€ÐµÐ·ÐµÐ½Ñ‚Ð°Ñ†Ð¸Ð¸ Ðº ÑƒÑ€Ð¾ÐºÐ°Ð¼', url: PRESENTATIONS_LINK }]
          ]
        }
      }
    );
    
    // Ð—Ð°Ñ‚ÐµÐ¼ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð»ÑÐµÐ¼ Ñ‚ÐµÐºÑÑ‚ Ð¿Ñ€Ð¾ ÑƒÑ€Ð¾Ðº Ð¸ ÐºÐ½Ð¾Ð¿ÐºÑƒ ÑƒÑ€Ð¾ÐºÐ°
    await ctx.reply(
      `Ð§Ñ‚Ð¾Ð±Ñ‹ Ð¾Ñ‚ÐºÑ€Ñ‹Ñ‚ÑŒ ÑƒÑ€Ð¾Ðº Ð¶Ð¼Ð¸ Ð½Ð° ÐºÐ½Ð¾Ð¿ÐºÑƒ Ð£Ñ€Ð¾Ðº 1 ðŸ‘‡`,
      {
        parse_mode: 'HTML',
        reply_markup: {
          inline_keyboard: [
            [{ text: 'Ð£Ñ€Ð¾Ðº 1', callback_data: 'lesson_1' }]
          ]
        }
      }
    );
    
  } catch (error) {
    console.error('ÐžÑˆÐ¸Ð±ÐºÐ° Ð² next_step:', error);
    return ctx.reply('ÐŸÑ€Ð¾Ð¸Ð·Ð¾ÑˆÐ»Ð° Ð¾ÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐµ Ð¼Ð°Ñ‚ÐµÑ€Ð¸Ð°Ð»Ð¾Ð².');
  }
});

// ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸Ðº Ð£Ñ€Ð¾ÐºÐ° 1
bot.action('lesson_1', (ctx) => {
  ctx.answerCbQuery().catch(() => {});
  return ctx.reply(
    'ðŸ“š Ð£Ñ€Ð¾Ðº 1: ÐžÑÐ½Ð¾Ð²Ñ‹ Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹ Ñ ÐºÐ¾Ð¼Ð¿ÑŒÑŽÑ‚ÐµÑ€Ð¾Ð¼\n\n' +
    'Ð¡Ð¾Ð´ÐµÑ€Ð¶Ð°Ð½Ð¸Ðµ ÑƒÑ€Ð¾ÐºÐ°...\n\n' +
    'Ð—Ð´ÐµÑÑŒ Ð±ÑƒÐ´ÐµÑ‚ Ð¼Ð°Ñ‚ÐµÑ€Ð¸Ð°Ð» Ð¿ÐµÑ€Ð²Ð¾Ð³Ð¾ ÑƒÑ€Ð¾ÐºÐ°.',
    {
      parse_mode: 'HTML',
      reply_markup: {
        inline_keyboard: [
          [{ text: 'Ð¡Ð»ÐµÐ´ÑƒÑŽÑ‰Ð¸Ð¹ ÑƒÑ€Ð¾Ðº', callback_data: 'lesson_2' }]
        ]
      }
    }
  );
});

// ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸Ðº Ñ‚ÐµÐºÑÑ‚Ð¾Ð²Ñ‹Ñ… ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹
bot.on('text', (ctx) => {
  return ctx.reply('Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹Ñ‚Ðµ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñƒ /start Ð´Ð»Ñ Ð½Ð°Ñ‡Ð°Ð»Ð° Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹');
});

// Ð—Ð°Ð¿ÑƒÑÐº Ð´Ð»Ñ Render
const PORT = process.env.PORT || 3000;

bot.launch({
  webhook: {
    domain: 'my-tutor-bot.onrender.com',
    port: PORT
  }
}).then(() => {
  console.log(`âœ… Ð‘Ð¾Ñ‚ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½ Ð½Ð° Ð¿Ð¾Ñ€Ñ‚Ñƒ ${PORT}`);
}).catch(err => {
  console.error('âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ð·Ð°Ð¿ÑƒÑÐºÐ°:', err);
});

process.once('SIGINT', () => bot.stop('SIGINT'));
process.once('SIGTERM', () => bot.stop('SIGTERM'));
